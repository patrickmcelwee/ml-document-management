!function(){"use strict";angular.module("ml.document-management",["ml.common","ml.uploader","ui.bootstrap"])}(),function(){"use strict";function e(e,t){var n={};return n.getDirectoryContents=function(e,n){return t.get("/v1/resources/directory-list",{params:{"rs:directory":e,"rs:case-uri":n}}).then(function(e){return e.data})},n.createDirectory=function(e){return t.post("/v1/resources/directory-list",null,{params:{"rs:directory-path":e}})},n}function t(e,t,r,o,a,i,c,s,u){function l(){s.transitionTo(s.current,n.extend({"#":i.hash()},u),{reload:!0,inherit:!1,notify:!0})}var m=function(o,i,c,s){function u(){o.mlcp={output_collections:"case-attachments",output_permissions:"cp-analyst,read,cp-analyst,update",transform_module:"/ext/mlcp/case-attachment-transform.xqy",transform_namespace:"http://marklogic.com/mlcp-case-attachment",transform_param:"case-uri="+o.caseUri+";annotation=Submitted by "+o.user.name+";sub-uri="+(o.subUri||"/"),thread_count:"16"}}o.user=a.currentUser()||{},o.model={},o.files=[],o.submitDirectory=function(){e.createDirectory(o.caseUri.replace(/\.xml$/,o.subUri||"/")+o.model.newDirectoryName+"/").then(function(){l()})},o.createDirectory=function(){o.$createDirectory=!0},o.closeDirectory=function(e){e.$open=!1},o.openDirectory=function(e){e.$open=!0},u(),i=n.element(i);var m=i.find('input[type="file"]:first');o.uploadFile=function(e){m.click(),e.stopPropagation()},o.$watch(function(){return a.currentUser()},function(e){e&&e.name&&(o.user=a.currentUser(),u())},!0),e.getDirectoryContents(o.caseUri.replace(/\.xml$/,o.subUri||"/"),o.caseUri).then(function(e){o.directories=e.directories,o.dirFiles=e.files});var d=i;i.parent(".parent-directory").length&&(d=i.parent(".parent-directory")),i.on("drop",function(e){return r.dropFiles(e,d,o)}).on("dragenter dragleave dragover",function(e){return r.dzHighlight(e,d)}),m.on("change",function(e){r.dropFiles(e,i,o)}),o.$watch(function(){return!!o.files[0]&&o.files[0].done},function(e){e&&l()}),o.model.archiveDocument=function(e){t.archiveDocument(e).then(function(){l()})},o.model.checkoutDocument=function(e){t.checkoutDocument(e).then(function(){l()})},o.model.checkinDocument=function(e){t.checkinDocument(e).then(function(){l()})},o.model.documentVersionsModal=t.openDocumentVersionsModal,o.model.editDocumentModal=t.editDocumentModal};return{restrict:"E",replace:!0,transclude:!0,scope:{caseUri:"=",subUri:"=",docsMeta:"="},compile:function(e){return o.compile(e,m)},templateUrl:"/ml-document-management/templates/directory-explorer.html"}}var n=window.angular,r=n.module("ml.document-management");r.factory("RecursionHelper",["$compile",function(e){return{compile:function(t,r){n.isFunction(r)&&(r={post:r});var o,a=t.contents().remove();return{pre:r&&r.pre?r.pre:null,post:function(t,n){o||(o=e(a)),o(t,function(e){n.append(e)}),r&&r.post&&r.post.apply(null,arguments)}}}}}]),r.service("directoryExplorerService",e).directive("directoryExplorer",t),e.$inject=["$rootScope","$http"],t.$injector=["directoryExplorerService","dlsService","mlUploadService","RecursionHelper","userService","$location","$q","$state","$stateParams"]}(),function(){"use strict";function e(e,t,n){function r(t,n,r,o){return e.post("/v1/resources/dls-management",o,{params:{"rs:uri":n,"rs:command":t,"rs:annotation":r}})}var o={openDLSModal:function(e){return t.open({animation:!0,templateUrl:"/ml-document-management/templates/dls.modal.html",controller:"DLSModalController",size:"lg",resolve:{config:function(){return e}}}).result},documentVersions:function(t){return e.get("/v1/resources/dls-management",{params:{"rs:command":"list-versions","rs:uri":t}}).then(function(e){return e.data.versions})},openDocumentVersionsModal:function(e,t){return o.documentVersions(t).then(function(t){return o.openDLSModal({info:{title:e+": Versions"},type:"versions-list",versions:t,fileName:e})})},editDocumentMetaModal:function(e){var t=e||{};e.role=e.role||"cp-analyst",e.metadata||(e.metadata=[]),e.metadata&&!angular.isArray(e.metadata)&&(e.metadata=[e.metadata]);var n=[],r=n.map(function(t,n){if(t.value===e.currentUserRole)return n}).filter(isFinite)[0];return n.splice(r+1),o.openDLSModal({info:{title:(e.fileName||"New File")+": Edit"},type:"edit-doc",item:t,model:{roles:n}})}};return o.setPermissions=function(e,t){return r("set-permissions",e,null,{role:t})},o.archiveDocument=function(t){return e["delete"]("/v1/resources/dls-management",{params:{"rs:uri":t}})},o.checkoutDocument=function(e){return r("checkout",e)},o.checkinDocument=function(e){return r("checkin",e)},o.patchMetadata=function(t,n,r){var o='<rapi:patch xmlns:rapi="http://marklogic.com/rest-api">'+(t.title?'<rapi:replace select="/case/associated-documents['+r+']/title">'+t.title+"</rapi:replace>":"")+(t.description?'<rapi:replace select="/case/associated-documents['+r+']/description">'+t.description+"</rapi:replace>":"");return t.metadata&&(o+='<rapi:delete select="/case/associated-documents['+r+']/metadata"  />',angular.isArray(t.metadata)||(t.metadata=[t.metadata]),angular.forEach(t.metadata,function(e,t){e&&(o+='<rapi:insert context="/case/associated-documents['+r+']" position="last-child"><metadata><label>'+e.label+"</label><value>"+e.value+"</value></metadata></rapi:insert>")})),o+="</rapi:patch>",e.patch("/v1/documents",o,{headers:{"Content-Type":"application/xml"},params:{uri:n}})},o.editDocumentModal=function(e,t,n){if(angular.isArray(n)){var r=t.document,a=t.metaIndex;if(t.metaIndex||angular.forEach(n,function(e,t){r===e.document&&(a=t+1)}),a>=1){var i=t.role;o.editDocumentMetaModal(t).then(function(n){n&&(n.title||n.description)&&o.patchMetadata(n,e,a).then(function(){t.title=n.title,t.description=n.description,n.role&&n.role!==i&&o.setPermissions(t.document,n.role)})})}}},o}function t(e,t,n){angular.extend(e,n),e.save=function(){t.close(e.item)},e.cancel=function(){t.dismiss("cancel")}}angular.module("ml.document-management").factory("dlsService",e).controller("DLSModalController",t).filter("verionedFileName",function(){return function(e,t){return e&&t?e.replace(/^(.*)\.([^\.]+)$/,"$1.v"+t+".$2"):e}}),e.$inject=["$http","$modal","$q"],t.$inject=["$scope","$modalInstance","config"]}();